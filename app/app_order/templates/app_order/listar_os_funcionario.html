{% extends "app_order/base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Minhas OS em Andamento</h2>
  {% if etapas %}
    <ul class="list-group mt-3">
      {% for st in etapas %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>Nº {{ st.order.numero_os|default:"—" }} – Serviço {{ st.ordem }}</strong><br>
            Criada em: {{ st.criado_em|date:"d/m/Y H:i" }}
          </div>
          <div>
            {% if st.order.status == 'aguardando' %}
              <button
                class="btn btn-sm btn-info btn-detalhes-os"
                data-os-id="{{ st.order.id }}"
                data-os-numero="{{ st.order.numero_os|default:'—' }}"
              >Ver Detalhes</button>
            {% else %}
              <a href="{% url 'acao_stage' stage_id=st.id %}"
                 class="btn btn-sm btn-primary">
                Gerenciar Serviço
              </a>
              <button
                class="btn btn-sm btn-info btn-detalhes-os"
                data-os-id="{{ st.order.id }}"
                data-os-numero="{{ st.order.numero_os|default:'—' }}"
              >Ver Detalhes</button>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="alert alert-info mt-3">
      Não há trabalhos em andamento para você.
    </div>
  {% endif %}

  <hr class="my-4">

  <h2>OS Criadas por mim</h2>
  {% if criadas %}
    <div class="table-responsive">
      <table class="table table-striped mt-2">
        <thead>
          <tr>
            <th>Nº</th>
            <th>Descrição</th>
            <th class="d-none d-sm-table-cell">Status</th>
            <th class="d-none d-md-table-cell">Data</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for os in criadas %}
            <tr>
              <td>{{ os.numero_os|default:"—" }}</td>
              <td>{{ os.descricao|truncatechars:40 }}</td>
              <td class="d-none d-sm-table-cell">{{ os.get_status_display }}</td>
              <td class="d-none d-md-table-cell">{{ os.data_solicitacao|date:"d/m/Y H:i" }}</td>
              <td>
                <button
                  class="btn btn-sm btn-info btn-detalhes-os"
                  data-os-id="{{ os.id }}"
                  data-os-numero="{{ os.numero_os|default:'—' }}"
                >Ver Detalhes</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-secondary mt-2">
      Você ainda não solicitou nenhuma OS.
    </div>
  {% endif %}

  <h2 class="mt-4">OS que colaborei</h2>
  {% if contribui %}
    <div class="table-responsive">
      <table class="table table-striped mt-2">
        <thead>
          <tr>
            <th>Nº</th>
            <th>Descrição</th>
            <th class="d-none d-sm-table-cell">Status</th>
            <th class="d-none d-md-table-cell">Data</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for os in contribui %}
            <tr>
              <td>{{ os.numero_os|default:"—" }}</td>
              <td>{{ os.descricao|truncatechars:40 }}</td>
              <td class="d-none d-sm-table-cell">{{ os.get_status_display }}</td>
              <td class="d-none d-md-table-cell">{{ os.data_solicitacao|date:"d/m/Y H:i" }}</td>
              <td>
                <button
                  class="btn btn-sm btn-info btn-detalhes-os"
                  data-os-id="{{ os.id }}"
                  data-os-numero="{{ os.numero_os|default:'—' }}"
                >Ver Detalhes</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-secondary mt-2">
      Você ainda não contribuiu em nenhuma OS.
    </div>
  {% endif %}
</div>

<!-- Modal para timeline -->
<div class="modal fade" id="modalDetalhesOS" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Historico - nº <span id="modalNumeroOS">—</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="conteudo-timeline" class="py-2"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const modalEl = document.getElementById('modalDetalhesOS');
  const modal   = new bootstrap.Modal(modalEl);
  const body    = modalEl.querySelector('#conteudo-timeline');
  const titulo  = modalEl.querySelector('#modalNumeroOS');

  document.querySelectorAll('.btn-detalhes-os').forEach(btn => {
    btn.addEventListener('click', () => {
      const osId     = btn.getAttribute('data-os-id');
      const numeroOs = btn.getAttribute('data-os-numero');
      // Atualiza o número no título do modal
      titulo.textContent = numeroOs;

      fetch(`/detalhes-os/${osId}/`)
        .then(response => {
          if (!response.ok) throw new Error('Falha ao carregar detalhes');
          return response.text();
        })
        .then(html => {
          body.innerHTML = html;
          modal.show();
        })
        .catch(error => {
          body.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
          modal.show();
        });
    });
  });
});
</script>
{% endblock %}
